jQuery(function($){"use strict";var root=$('.medias-root');var scrollable_container=$('.scrollable-container',root);var medias_list=$('.medias-list',root);var temp_medias_list=$('.temp-medias-list',root);var settings=$.parseJSON(root.attr('data-settings'));var temp_medias_title=$('.temp-medias-title',root);var medias_title=$('.medias-title',root);var upload_btn=$('.btn-upload',root);var save_btn=$('.btn-save',root);var upload_modal=$('#media-upload-modal');var media_dropzone_area=$('.media-dropzone-area',upload_modal);var media_dropzone_filetable=$('.media-dropzone-filetable',upload_modal);var temp_media_template='<li data-id="|ID|"><span class="label label-orange name">|NAME|</span><span class="btn btn-xs btn-icon-standalone btn-red btn-delete-temp"><i class="fa-remove"></i></span></li>';var media_operation_modal=$('#media-operation-modal');upload_btn.click(function()
{upload_modal.modal('show')});var i=1;var dropzone=media_dropzone_area.dropzone({url:window.Laravel.routes.medias.upload_temp,addedfile:function(file)
{if(i===1)
{media_dropzone_filetable.find('tbody').html('');}
var size=parseInt(file.size/1024,10);size=size<1024?(size+" KB"):(parseInt(size/1024,10)+" MB");var $entry=$('<tr>\
                                                <td class="text-center">'+(i++)+'</td>\
                                                <td>'+file.name+'</td>\
                                                <td><div class="progress progress-striped"><div class="progress-bar progress-bar-warning"></div></div></td>\
                                                <td>'+size+'</td>\
                                                <td>Yükleniyor...</td>\
                                            </tr>');media_dropzone_filetable.find('tbody').append($entry);file.fileEntryTd=$entry;file.progressBar=$entry.find('.progress-bar');},sending:function(file,xhr,formData){formData.append('_token',window.Laravel.csrf_token);formData.append('temp_key',settings.temp_key);},uploadprogress:function(file,progress,bytesSent)
{file.progressBar.width(progress+'%');},success:function(file)
{file.fileEntryTd.find('td:last').html('<span class="text-success">Yüklendi</span>');file.progressBar.removeClass('progress-bar-warning').addClass('progress-bar-success');},error:function(file)
{file.fileEntryTd.find('td:last').html('<span class="text-danger">Hatalı!</span>');file.progressBar.removeClass('progress-bar-warning').addClass('progress-bar-red');}});media_dropzone_area.css({minHeight:200});upload_modal.on('hidden.bs.modal',function(){media_dropzone_filetable.find('tbody').html('<tr><td colspan="5">Yüklenen medya burada görüntülenir..</td></tr>');media_dropzone_area.removeAttr('data-settings');getTemp();});function getTemp(callback)
{$.ajax({url:window.Laravel.routes.medias.get_temp,type:'post',data:settings,dataType:'json',beforeSend:function(){temp_medias_list.html('');},complete:function(){if(typeof callback!==typeof undefined){callback();}},success:function(medias){$.each(medias,function(i,media)
{var html=temp_media_template.replace(/\|ID\|/g,media.id).replace(/\|NAME\|/g,media.file_name);temp_medias_list.append(html);});if(medias.length===0){temp_medias_title.addClass('hidden');}else{temp_medias_title.removeClass('hidden');}},error:function(){}});}
getTemp();temp_medias_list.on('click','.btn-delete-temp',function()
{var li=$(this).parents('li:eq(0)');media_operation_modal.attr('data-list-type','temp-medias-list');media_operation_modal.attr('data-id',li.attr('data-id'));media_operation_modal.attr('data-url',window.Laravel.routes.medias.delete_temp);$('.name',media_operation_modal).text($('.name',li).text());$('.modal-title',media_operation_modal).text('Geçici Medya Silinecek!');media_operation_modal.modal('show');});medias_list.on('click','.btn-detach',function()
{var li=$(this).parents('li:eq(0)');media_operation_modal.attr('data-list-type','medias-list');media_operation_modal.attr('data-id',li.attr('data-id'));media_operation_modal.attr('data-url',window.Laravel.routes.medias.detach);$('.name',media_operation_modal).text($('.name',li).text());$('.modal-title',media_operation_modal).text('Medya Bağlantısı Kaldırılacak!');media_operation_modal.modal('show');});medias_list.on('click','.btn-remove',function()
{var li=$(this).parents('li:eq(0)');media_operation_modal.attr('data-list-type','medias-list');media_operation_modal.attr('data-id',li.attr('data-id'));media_operation_modal.attr('data-url',window.Laravel.routes.medias.delete);$('.name',media_operation_modal).text($('.name',li).text());$('.description',media_operation_modal).text('İlişkili olan tüm içeirklerden de kaldırılacak!');$('.modal-title',media_operation_modal).text('Medya Silinecek!');media_operation_modal.modal('show');});medias_list.on('click','.btn-preview',function()
{var li=$(this).parents('li:eq(0)');var media_id=li.attr('data-id');var type=li.attr('data-type');$.fancybox.open({src:window.Laravel.routes.medias.preview.replace('|ID|',media_id)+'?w=1280&h=720&q=80&m=resize',type:type,width:'100%',height:'100%',opts:{afterShow:function(instance,current){}}});});media_operation_modal.on('hidden.bs.modal',function(){media_operation_modal.removeAttr('data-id');media_operation_modal.removeAttr('data-url');media_operation_modal.removeAttr('data-list-type');$('.name',media_operation_modal).text('');$('.description',media_operation_modal).text('');$('.modal-title',media_operation_modal).text('');});media_operation_modal.on('click','.action-button',function(){var button=$(this);var id=media_operation_modal.attr('data-id');var list_type=media_operation_modal.attr('data-list-type');if(!button.hasClass('disabled')){$.ajax({url:media_operation_modal.attr('data-url'),data:{id:id,table_type:settings.table_type,table_id:settings.table_id},type:'delete',dataType:'json',beforeSend:function(){button.addClass('disabled');},complete:function(){button.removeClass('disabled');},success:function(data){toastr.success('İşlem tamamlandı.');$('.'+list_type+' li[data-id="'+id+'"]').remove();media_operation_modal.modal('hide');getTemp();},error:function(){toastr.error('Hata oldu!');}});}});save_btn.click(function(){if(!save_btn.hasClass('disabled')){$.ajax({url:window.Laravel.routes.medias.save_temp,data:{medias_temp_key:settings.temp_key,table_type:settings.table_type,table_id:settings.table_id},type:'post',dataType:'json',beforeSend:function(){save_btn.addClass('disabled');},complete:function(){save_btn.removeClass('disabled');},success:function(data){toastr.success('Temp Kaydedildi.');window.location.reload();},error:function(){toastr.error('Hata oldu!');}});}});medias_list.sortable({items:'> li',containment:'parent',handle:'.handle',update:function()
{$.ajax({url:window.Laravel.routes.medias.sort,data:{ids:medias_list.sortable('toArray',{attribute:'data-id'}),table_type:settings.table_type,table_id:settings.table_id},type:'put',dataType:'json',beforeSend:function(){},complete:function(){},success:function(data){toastr.success('Sıralama Kaydedildi.');},error:function(){toastr.error('Hata oldu!');}});}});scrollable_container.perfectScrollbar({wheelPropagation:true});function loadPreviewImages(){$('.preview-image:not(".loaded,.loading")',medias_list).each(function(){var img=$(this);var li=img.parents('li:eq(0)');if(li.isInViewportContainer(scrollable_container)){loadPreviewImage(li,img);}});}
function loadPreviewImage(li,img){if(!img.hasClass('loading')&&!img.hasClass('loaded')){$.ajax({url:window.Laravel.routes.medias.preview.replace('|ID|',li.attr('data-id')),type:'get',beforeSend:function(){img.addClass('loading').attr('src',window.Laravel.app_url+'/images/double-ring.gif');},completed:function(){img.removeClass('loading').addClass('loaded');},success:function(data){img.attr('src',data);},error:function(){img.attr('src',window.Laravel.app_url+'/images/double-ring.gif');}});}}
medias_list.on('mouseenter','.preview-image:not(".loaded,.loading")',function(){var img=$(this);var li=img.parents('li:eq(0)');loadPreviewImage(li,img);});$(document).ready(function(){setTimeout(function(){scrollable_container.scroll(function(){loadPreviewImages();});},200);setTimeout(function(){loadPreviewImages();},500);});});